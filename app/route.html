<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Zuid Afrika 2016</title>
    <link rel="stylesheet" href="styles/main.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBHcfnog5eeARmFaWn5C9Idfhju-FpOqlI&sensor=false"></script>
    <script>
      jQuery(function() {
var stops = [
// "O.R. Tambo International Airport, Johannesburg, South Africa",
"-26.1366728,28.2389572",
// "Protea Hotel Manor, Pretoria, Gauteng, South Africa",
"-25.7505428,28.2308334",
// "Voortrekker Monument, Eeufees Rd, Pretoria, 0027, South Africa",
"-25.7763285,28.1736098",
// "Kruger House & Museum, WF Nkomo Street, Pretoria, South Africa",
"-25.7464999,28.1795513",
// "Misty Mountain, Thaba Chweu, Mpumalanga, South Africa",
"-25.17497,30.6575913",
// "Bourke's Luck Potholes, Thaba Chweu, Mpumalanga, South Africa",
"-24.6744049,30.8087596",
// "Blyde River Canyon, Thaba Chweu, Mpumalanga, South Africa",
"-24.5911953,30.7953763",
// "Wonder View, Thaba Chweu, Mpumalanga, South Africa",
"-24.8683131,30.8945525",
// "Pine Lake Resort, Mbombela, Mpumalanga, South Africa",
"-25.280195,30.9965393",
// "Phabeni Gate, Kruger National Park, Kruger Park, Mpumalanga, South Africa",
"-25.0251705,31.2389057",
// "Pine Lake Resort, Mbombela, Mpumalanga, South Africa",
"-25.280195,30.9965393",
// "Jeppes Reef, Nkomazi, Mpumalanga, South Africa",
"-25.7503744,31.4685908",
// "Lugogo Sun, MR103, Lobamba, Swaziland",
"-26.4094076,31.1741914",
// "Border Posts - Golela, MR8, Pongola, KwaZoeloe-Natal, South Africa",
"-27.3089419,31.8759512",
// "Hluhluweâ€“iMfolozi Park, St Lucia Park, KwaZoeloe-Natal, South Africa",
"-28.2198305,31.9496765",
// "Elifant Lake Inn, Flamingo Street, Saint Lucia, South Africa",
"-28.377518,32.4103103",
// "Durban, KwaZoeloe-Natal, South Africa",
"-29.8483609,30.9223192",
// "Howick Falls, Falls Drive, Howick, South Africa",
"-29.4859411,30.2366495",
// "Gooderson Drakensberg Gardens Golf & Spa Resort, Drakensberg Gardens Road, Underberg, 3257, South Africa",
"-29.754906,29.2375973",
// "Sani Mountain Lodge, Mkhomazi Wilderness area, Thaba-Tseka, Lesotho",
"-29.5845233,29.2861621",
// "Gooderson Drakensberg Gardens Golf & Spa Resort, Drakensberg Gardens Road, Underberg, 3257, South Africa",
"-29.754906,29.2375973",
// "Umnenga Lodge, Glen Eden Road, Glen Gariff, East London, South Africa",
"-32.8822743,28.0896486",
// "Kwazakele 3, Ibhayi, South Africa",
"-33.8833941,25.5678932",
// "Summerstrand Hotel Port Elizabeth, Marine Drive, Port Elizabeth, Eastern Cape, South Africa",
"-33.9936815,25.6746307",
// "Donkin Reserve, Port Elizabeth, South Africa",
"-33.9618985,25.6198603",
// "Cape St Francis Resort Hotel, Da Gama Road, Cape Saint Francis, South Africa",
"-34.1989382,24.8293748",
// "The Big Tree Tsitsikamma, N2, Stormsrivier, South Africa",
"-33.96608,23.8931823",
// "Storms River Mouth, Aberdeen Plain, Eastern Cape, South Africa",
"-34.0203,23.9007713",
// "Knysna, Western Cape, South Africa",
"-34.0391361,23.007397",
// "The Wilderness Hotel, George Road, Wildernis, South Africa",
"-33.9930137,22.5748755",
// "Sedgefield, Western Cape, South Africa",
"-34.0185907,22.7972806",
// "The Wilderness Hotel, George Road, Wildernis, South Africa",
"-33.9930137,22.5748755",
// "Safari Ostrich Show Farm, R328, Oudtshoorn, South Africa",
"-33.630527,22.1594273",
// "Cango Caves, Oudtshoorn, South Africa",
"-33.3923,22.2127113",
// "Kobus se Gat (Back packers/Mt bikers rest), Scenic Cape Route 62, Western Cape, South Africa",
"-33.38854,22.1052113",
// "Swartberg Pass, Oudtshoorn, Western Cape, South Africa",
"-33.3547214,22.0429119",
// "Oudtshoorn Inn, Van Der Riet Street, Oudtshoorn, South Africa",
"-33.583867,22.2026893",
// "The Country Pumpkin, Barrydale, Western Cape, South Africa",
"-33.9052293,20.7143545",
// "Robertson Winery, Robertson, South Africa",
"-33.8104753,19.8788001",
// "Garden Court Nelson Mandela Boulevard, Cape Town, South Africa",
"-33.9347119,18.4456409",
// "St George's Cathedral, Wale Street, Cape Town, South Africa",
"-33.924845,18.4171633",
// "Bo-Kaap, Cape Town, Western Cape, South Africa",
"-33.92107,18.4095455",
// "V&A Waterfront, Cape Town, South Africa",
"-33.9067241,18.419504",
// "Garden Court Nelson Mandela Boulevard, Cape Town, South Africa",
"-33.9347119,18.4456409",
// "Table Mountain, Cape Town, Western Cape, South Africa",
"-33.9628212,18.4010858",
// "Boulders Beach, Kleintuin Road, South Africa",
"-34.1972201,18.4490964",
// "Cape of Good Hope, Cape Town, South Africa",
"-34.3568425,18.4717995",
// "Cape Point, Cape Town, Western Cape, South Africa",
"-34.244437,18.3386927",
// "Garden Court Nelson Mandela Boulevard, Cape Town, South Africa",
"-33.9347119,18.4456409",
// "Long Street, Cape Town, Western Cape, South Africa",
"-33.922015,18.4174353",
// "Duiker Island, Hout Bay, South Africa",
"-34.0585978,18.3246316",
// "Camps Bay Beach, 63 Victoria Rd, Camps Bay, Cape Town, 8040, South Africa",
"-33.9506605,18.3754526",
// "Richard's Supper Stage and Bistro, Main Road, Cape Town, South Africa",
"-33.908712,18.3954171",
// "Garden Court Nelson Mandela Boulevard, Cape Town, South Africa",
"-33.9347119,18.4456409",
// "Drakenstein Prison, Paarl, Western Cape, South Africa",
"-33.845273,19.009738",
// "Stellenbosch, South Africa",
"-33.9328078,18.8622583",
// "Road Lodge Cape Town International Airport, Cape Town, South Africa"
"-33.9698493,18.5897486",
];

    var map = new window.google.maps.Map(document.getElementById("map"));

    // new up complex objects before passing them around
    var directionsDisplay = new window.google.maps.DirectionsRenderer({suppressMarkers: true});
    var directionsService = new window.google.maps.DirectionsService();

    Tour_startUp(stops);

    window.tour.loadMap(map, directionsDisplay);
    window.tour.fitBounds(map);

    if (stops.length > 1)
        window.tour.calcRoute(directionsService, directionsDisplay);
});

function Tour_startUp(stops) {
    if (!window.tour) window.tour = {
        updateStops: function (newStops) {
            stops = newStops;
        },
        // map: google map object
        // directionsDisplay: google directionsDisplay object (comes in empty)
        loadMap: function (map, directionsDisplay) {
            var myOptions = {
                zoom: 6,
                center: new window.google.maps.LatLng(-28.405, 20.180), // Zuid Afrika
                mapTypeId: window.google.maps.MapTypeId.ROADMAP
            };
            map.setOptions(myOptions);
            directionsDisplay.setMap(map);
        },
        fitBounds: function (map) {
            var bounds = new window.google.maps.LatLngBounds();

            // extend bounds for each record
/*
            jQuery.each(stops, function (key, val) {
                var myLatlng = new window.google.maps.LatLng(val.Geometry.Latitude, val.Geometry.Longitude);
                bounds.extend(myLatlng);
            });
            map.fitBounds(bounds);
*/
        },
        calcRoute: function (directionsService, directionsDisplay) {
            var batches = [];
            var itemsPerBatch = 10; // google API max = 10 - 1 start, 1 stop, and 8 waypoints
            var itemsCounter = 0;
            var wayptsExist = stops.length > 0;

            while (wayptsExist) {
                var subBatch = [];
                var subitemsCounter = 0;

                for (var j = itemsCounter; j < stops.length; j++) {
                    subitemsCounter++;
                    subBatch.push({
                        location: stops[j],
                        stopover: true
                    });
                    if (subitemsCounter == itemsPerBatch)
                        break;
                }

                itemsCounter += subitemsCounter;
                batches.push(subBatch);
                wayptsExist = itemsCounter < stops.length;
                // If it runs again there are still points. Minus 1 before continuing to
                // start up with end of previous tour leg
                itemsCounter--;
            }

            // now we should have a 2 dimensional array with a list of a list of waypoints
            var combinedResults;
            var unsortedResults = [{}]; // to hold the counter and the results themselves as they come back, to later sort
            var directionsResultsReturned = 0;

            for (var k = 0; k < batches.length; k++) {
                var lastIndex = batches[k].length - 1;
                var start = batches[k][0].location;
                var end = batches[k][lastIndex].location;

                // trim first and last entry from array
                var waypts = [];
                waypts = batches[k];
                waypts.splice(0, 1);
                waypts.splice(waypts.length - 1, 1);

                var request = {
                    origin: start,
                    destination: end,
                    waypoints: waypts,
                    travelMode: window.google.maps.TravelMode.DRIVING
                };
                (function (kk) {
                    directionsService.route(request, function (result, status) {
                        if (status == window.google.maps.DirectionsStatus.OK) {

                            var unsortedResult = { order: kk, result: result };
                            unsortedResults.push(unsortedResult);

                            directionsResultsReturned++;

                            if (directionsResultsReturned == batches.length) // we've received all the results. put to map
                            {
                                // sort the returned values into their correct order
                                unsortedResults.sort(function (a, b) { return parseFloat(a.order) - parseFloat(b.order); });
                                var count = 0;
                                for (var key in unsortedResults) {
                                    if (unsortedResults[key].result != null) {
                                        if (unsortedResults.hasOwnProperty(key)) {
                                            if (count == 0) // first results. new up the combinedResults object
                                                combinedResults = unsortedResults[key].result;
                                            else {
                                                // only building up legs, overview_path, and bounds in my consolidated object. This is not a complete
                                                // directionResults object, but enough to draw a path on the map, which is all I need
                                                combinedResults.routes[0].legs = combinedResults.routes[0].legs.concat(unsortedResults[key].result.routes[0].legs);
                                                combinedResults.routes[0].overview_path = combinedResults.routes[0].overview_path.concat(unsortedResults[key].result.routes[0].overview_path);

                                                combinedResults.routes[0].bounds = combinedResults.routes[0].bounds.extend(unsortedResults[key].result.routes[0].bounds.getNorthEast());
                                                combinedResults.routes[0].bounds = combinedResults.routes[0].bounds.extend(unsortedResults[key].result.routes[0].bounds.getSouthWest());
                                            }
                                            count++;
                                        }
                                    }
                                }
                                directionsDisplay.setDirections(combinedResults);
                                var legs = combinedResults.routes[0].legs;
                                // alert(legs.length);
                                for (var i=0; i < legs.length;i++){
                                  var markerletter = "A".charCodeAt(0);
                                  markerletter += i;
                                  markerletter = String.fromCharCode(markerletter);
                                  createMarker(directionsDisplay.getMap(),i,legs[i].start_location,legs[i].start_address);
                                }
                                var i=legs.length;
                                var markerletter = "A".charCodeAt(0);
                                markerletter += i;
                                markerletter = String.fromCharCode(markerletter);
                                createMarker(directionsDisplay.getMap(),i,legs[legs.length-1].end_location,legs[legs.length-1].end_address);
                            }
                        }
                    });
                })(k);
            }
        }
    };
}
var infowindow = new google.maps.InfoWindow(
  { 
    size: new google.maps.Size(150,50)
  });

var icons = new Array();
icons["red"] = new google.maps.MarkerImage("mapIcons/marker_red.png",
      // This marker is 20 pixels wide by 34 pixels tall.
      new google.maps.Size(20, 34),
      // The origin for this image is 0,0.
      new google.maps.Point(0,0),
      // The anchor for this image is at 9,34.
      new google.maps.Point(9, 34));



function getMarkerImage(iconStr) {
   if ((typeof(iconStr)=="undefined") || (iconStr==null)) { 
      iconStr = "red"; 
   }
   if (!icons[iconStr]) {
      icons[iconStr] = new google.maps.MarkerImage("http://www.google.com/mapfiles/marker"+ iconStr +".png",
      // This marker is 20 pixels wide by 34 pixels tall.
      new google.maps.Size(20, 34),
      // The origin for this image is 0,0.
      new google.maps.Point(0,0),
      // The anchor for this image is at 6,20.
      new google.maps.Point(9, 34));
   } 
   return icons[iconStr];

}

function getMarkerIcon(id) {
    if (id === 0 || id === 56) {
        // airports
        return "https://mt.google.com/vt/icon/name=icons/onion/SHARED-mymaps-container-bg_4x.png,icons/onion/SHARED-mymaps-container_4x.png,icons/onion/1504-airport-plane_4x.png&highlight=ff000000,a80606,ff000000&scale=0.8";
    } else if (id === 1 || id === 4 || id === 8 || id === 10 || id === 12 || id === 15 || id === 18 || id === 20 || id === 21 || id === 23 || id === 25 || id === 29 || id === 31 || id === 36 || id === 39 || id === 43 || id === 48 || id === 53) {
        // hotels
        return "https://mt.google.com/vt/icon/name=icons/onion/SHARED-mymaps-container-bg_4x.png,icons/onion/SHARED-mymaps-container_4x.png,icons/onion/1602-hotel-bed_4x.png&highlight=ff000000,1f3677,ff000000&scale=0.8";
    } else {
        return "https://mt.google.com/vt/icon/name=icons/onion/SHARED-mymaps-pin-container-bg_4x.png,icons/onion/SHARED-mymaps-pin-container_4x.png,icons/onion/1899-blank-shape_pin_4x.png&highlight=ff000000,0288D1,ff000000&scale=0.7"
        // return "#";
    }
    
}

  // Marker sizes are expressed as a Size of X,Y
  // where the origin of the image (0,0) is located
  // in the top left of the image.
 
  // Origins, anchor positions and coordinates of the marker
  // increase in the X direction to the right and in
  // the Y direction down.

  var iconImage = new google.maps.MarkerImage('mapIcons/marker_red.png',
      // This marker is 20 pixels wide by 34 pixels tall.
      new google.maps.Size(20, 34),
      // The origin for this image is 0,0.
      new google.maps.Point(0,0),
      // The anchor for this image is at 9,34.
      new google.maps.Point(9, 34));
  var iconShadow = new google.maps.MarkerImage('http://www.google.com/mapfiles/shadow50.png',
      // The shadow image is larger in the horizontal dimension
      // while the position and offset are the same as for the main image.
      new google.maps.Size(37, 34),
      new google.maps.Point(0,0),
      new google.maps.Point(9, 34));
      // Shapes define the clickable region of the icon.
      // The type defines an HTML &lt;area&gt; element 'poly' which
      // traces out a polygon as a series of X,Y points. The final
      // coordinate closes the poly by connecting to the first
      // coordinate.
  var iconShape = {
      coord: [9,0,6,1,4,2,2,4,0,8,0,12,1,14,2,16,5,19,7,23,8,26,9,30,9,34,11,34,11,30,12,26,13,24,14,21,16,18,18,16,20,12,20,8,18,4,16,2,15,1,13,0],
      type: 'poly'
  };


function createMarker(map, id, latlng, label) {
// alert("createMarker("+latlng+","+label+","+html+","+color+")");
    var contentString = '<b>'+id+'</b>';
    var marker = new google.maps.Marker({
            position: latlng,
            map: map,
            icon: getMarkerIcon(id),
            title: label
        })

        marker.myname = label;

    google.maps.event.addListener(marker, 'click', function() {
        infowindow.setContent(contentString); 
        infowindow.open(map,marker);
        });
    return marker;
}
    </script>
  </head>
  <body>
  <div id="map"></div>
</body>
</html>
